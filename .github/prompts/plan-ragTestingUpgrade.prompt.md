# Plan: RAG 테스팅 프롬프트 엄격화 업그레이드 ✅ 완료

현재 테스팅 프롬프트가 "대체로 만족"으로 평가하는 문제를 해결하기 위해, **LLM 답변 품질 평가 강화**, **멀티턴 대화 테스트 필수화**, **사용자 의도 검증 엄격화** 세 가지 축으로 프롬프트를 업그레이드합니다.

## 적용 완료 요약

| Step | 내용 | 상태 |
|------|------|------|
| 1 | Phase 2에 "의도 충족 검증" 추가 | ✅ |
| 2 | Phase 4 멀티턴 테스트 필수화 (5턴×2개, 80% 목표) | ✅ |
| 3 | "행동 가능성" 평가 항목 + 일반론 답변 감지 패턴 추가 | ✅ |
| 4 | 후속 질문 제안 품질 검증 섹션 추가 | ✅ |
| 5 | Phase 4.5 실패 케이스 5-Why 분석 추가 | ✅ |
| 6 | 멀티턴 시나리오 템플릿 라이브러리 (7개 페르소나) 추가 | ✅ |

## 현황 분석

| 영역 | 현재 상태 | 문제점 |
|------|----------|--------|
| LLM 답변 품질 평가 | ❌ 미지원 | auto_evaluate.py는 검색 결과만 평가, LLM 답변 품질 미검증 |
| 멀티턴 테스트 케이스 | ❌ 0개 | evaluation_dataset.json에 멀티턴 시나리오 전무 |
| 난이도별 테스트 분류 | ❌ 없음 | 프롬프트의 30%/40%/30% 기준이 데이터셋에 미반영 |
| 팩트체크 자동화 | ❌ 수동 | 모든 검증이 수동 쿼리 실행 필요 |
| Phase 4 멀티턴 | 선택적 | Phase 2-3보다 낮은 우선순위로 취급됨 |

## Steps

### 1. [Phase 2] 동적 쿼리 테스트를 "의도 충족 검증" 중심으로 재설계

**대상 파일**: `.github/prompts/rag-testing.prompt.md` (Phase 2 섹션)

**변경 내용**:
- 각 쿼리에 `expected_user_satisfaction` 필드 추가
  - "사용자가 이 답변으로 다음 행동을 할 수 있는가?" 검증 기준 명시
- "의도 충족 체크리스트" 신규 추가:
  - [ ] 사용자가 원하는 **구체적 행동**이 명확히 안내되었는가?
  - [ ] **다음 단계**가 무엇인지 알 수 있는가?
  - [ ] **예상 결과**가 설명되었는가?
  - [ ] 필요한 **준비물/조건**이 명시되었는가?

**예시**:
```
[쿼리] "휴학하고 싶어요"

[의도 충족 검증]
- 사용자의 진짜 의도: 휴학 절차를 알고 싶음
- 기대 행동: 휴학 신청서 제출
- 필수 정보: ✅ 신청 기간, ✅ 필요 서류, ✅ 제출처
- 행동 가능성: ✅ 사용자가 바로 행동 가능

판정: 의도 충족 ✅
```

---

### 2. [Phase 4] 멀티턴 테스트를 필수 Phase로 격상

**대상 파일**: `.github/prompts/rag-testing.prompt.md` (Phase 4 섹션 + 성공 기준)

**변경 내용**:

#### 2.1 성공 기준 테이블 수정
```markdown
| 메트릭 | 목표 | 엄격 모드 적용 |
|--------|------|---------------|
| 멀티턴 대화 성공률 | ≥ 80% | **필수** (기존 75% → 80%로 상향) |
| **후속 질문 성공률** | **≥ 85%** | **신규 추가** |
```

#### 2.2 페르소나당 멀티턴 시나리오 최소 요건
- 기존: 1개 이상의 3턴 대화
- 변경: **2개 이상의 5턴 대화** (필수)

#### 2.3 멀티턴 평가 항목 확장
| 항목 | 평가 내용 | 배점 |
|------|----------|------|
| **맥락 유지** | 이전 대화 내용을 기억하고 반영 | 1.0 |
| **정보 일관성** | Turn 간 모순 없음 | 1.0 |
| **점진적 심화** | 후속 질문에 더 구체적 정보 제공 | 1.0 |
| **중복 회피** | 불필요한 반복 없음 | 0.5 |
| **자연스러운 전환** | 대화 흐름이 자연스러움 | 0.5 |
| **후속 질문 예측** | 적절한 후속 질문 제안 | 1.0 |
| **합계** | | 5.0 |

---

### 3. "부분 성공 = 실패" 원칙 전면 강화

**대상 파일**: `.github/prompts/rag-testing.prompt.md` (Phase 3 섹션)

**변경 내용**:

#### 3.1 "Actionability(행동 가능성)" 평가 항목 추가
```markdown
| 항목 | 배점 | 평가 기준 | 자동 감점 조건 |
|------|------|----------|---------------|
| **정확성** | 1.0 | 규정 내용과 일치 | 팩트체크 실패 시 **0점** |
| **완전성** | 1.0 | 질문의 모든 측면에 답변 | 복합질문 중 1개 누락 시 **-0.5** |
| **관련성** | 1.0 | 질문 의도에 맞는 답변 | 50% 이상 무관한 내용 시 **0점** |
| **출처 명시** | 1.0 | 규정명/조항 인용 | 출처 없는 단정 시 **0점** |
| **실용성** | 0.5 | 기한/서류/담당부서 포함 | 절차질문에 기한 없으면 **-0.25** |
| **행동 가능성** | 0.5 | 사용자가 바로 행동 가능 | 기한/서류/담당부서 중 2개↑ 누락 시 **0점** |
| **합계** | 5.0 | | |
```

#### 3.2 "일반론 답변" 자동 감지 패턴 추가
```markdown
### 3.6 일반론 답변 감지 패턴 (자동 실패)

다음 패턴이 답변에 포함되면 **GENERIC_ANSWER**로 즉시 실패 처리:

| 패턴 | 예시 | 이유 |
|------|------|------|
| `대학마다 다를 수 있습니다` | "일반적으로... 대학마다 다를 수 있습니다" | 회피성 답변 |
| `확인이 필요합니다` | "정확한 내용은 학교에 확인이 필요합니다" | 책임 회피 |
| `일반적으로` (규정 인용 없이) | "일반적으로 휴학은..." | 이 학교 규정 미인용 |
| `담당 부서에 문의` (구체 부서명 없이) | "자세한 내용은 담당 부서에 문의하세요" | 비구체적 안내 |
| `상황에 따라 다릅니다` (조건 미명시) | "상황에 따라 다릅니다" | 조건 미제시 |
```

---

### 4. 후속 질문 예측 검증 추가

**대상 파일**: `.github/prompts/rag-testing.prompt.md` (Phase 3 이후 새 섹션)

**신규 섹션**:
```markdown
### 3.7 후속 질문 제안 품질 검증

시스템이 제안하는 후속 질문(`suggestions`)이 사용자 의도 흐름과 일치하는지 검증합니다.

#### 검증 체크리스트
- [ ] **관련성**: 제안된 질문이 현재 주제와 관련있는가?
- [ ] **자연스러움**: 실제 사용자가 물어볼 법한 질문인가?
- [ ] **심화 방향**: 더 구체적인 정보로 안내하는가?
- [ ] **다양성**: 서로 다른 측면을 다루는가? (중복 없음)
- [ ] **실용성**: 사용자에게 실질적 도움이 되는 질문인가?

#### 후속 질문 품질 점수
| 점수 | 기준 |
|------|------|
| 5/5 | 모든 제안이 관련성 높고 자연스러움 |
| 4/5 | 1개 제안이 약간 관련성 부족 |
| 3/5 | 2개 제안이 관련성 부족 또는 중복 |
| 2/5 | 대부분 제안이 부적절 |
| 1/5 | 제안이 없거나 모두 무관함 |

#### 나쁜 후속 질문 예시
```
원래 질문: "휴학하고 싶어요"

❌ 나쁜 제안:
- "학교 역사가 궁금하신가요?" (무관함)
- "휴학이 무엇인가요?" (이미 알고 있음)
- "다른 규정을 검색하시겠습니까?" (너무 일반적)

✅ 좋은 제안:
- "휴학 기간은 얼마나 할 수 있나요?"
- "휴학 중 등록금은 어떻게 되나요?"
- "복학 절차도 알려드릴까요?"
```
```

---

### 5. 실패 케이스 심층 분석 템플릿 추가

**대상 파일**: `.github/prompts/rag-testing.prompt.md` (Phase 5 앞에 새 섹션)

**신규 섹션**:
```markdown
## Phase 4.5: 실패 케이스 심층 분석 (5-Why)

실패한 모든 쿼리에 대해 **근본 원인 분석**을 수행합니다.

### 4.5.1 5-Why 분석 템플릿

```
[실패 쿼리] "장학금 받고 있는데 휴학하면 어떻게 돼?"
[실패 유형] INCOMPLETE

Why 1: 왜 실패했는가?
→ 장학금 유형별 처리 방법이 누락됨

Why 2: 왜 누락되었는가?
→ 검색 결과에 장학금-휴학 연계 정보가 없었음

Why 3: 왜 검색되지 않았는가?
→ "장학금 휴학" 키워드 조합이 인텐트에 없음

Why 4: 왜 인텐트에 없는가?
→ 복합 상황(A+B) 시나리오가 인텐트 설계에 미반영

Why 5: 근본 원인은?
→ 인텐트 설계가 단일 주제 중심이며, 주제 간 연계 시나리오 부재

[조치 방안]
- data/config/intents.json에 복합 인텐트 추가
- 예: "scholarship_leave" 인텐트 신설
```

### 4.5.2 실패 유형별 근본 원인 카테고리

| 실패 유형 | 1차 원인 | 근본 원인 카테고리 |
|----------|---------|-------------------|
| `WRONG_FACT` | LLM이 잘못된 정보 생성 | **생성 실패** - 프롬프트/컨텍스트 문제 |
| `HALLUCINATION` | 존재하지 않는 규정 언급 | **생성 실패** - Grounding 부족 |
| `GENERIC_ANSWER` | 규정 미인용 | **검색 실패** - 관련 청크 미검색 |
| `IRRELEVANT` | 의도 파악 실패 | **의도 파악 실패** - 인텐트 매칭 문제 |
| `INCOMPLETE` | 정보 누락 | **검색 실패** 또는 **생성 실패** |
| `NO_SOURCE` | 출처 미명시 | **생성 실패** - 프롬프트 문제 |

### 4.5.3 근본 원인별 개선 방향

| 근본 원인 | 개선 방향 | 담당 Phase |
|----------|----------|-----------|
| **검색 실패** | 인텐트/동의어 추가, 쿼리 확장 개선 | Phase 5.3 |
| **생성 실패** | 프롬프트 개선, 컨텍스트 구성 개선 | Phase 5.4 |
| **의도 파악 실패** | 인텐트 패턴 추가, 청중 감지 개선 | Phase 5.3-5.4 |
```

---

### 6. 멀티턴 시나리오 템플릿 라이브러리 추가

**대상 파일**: `.github/prompts/rag-testing.prompt.md` (부록 섹션)

**신규 섹션**:
```markdown
## 부록 B: 멀티턴 시나리오 템플릿 라이브러리

페르소나별 대표 멀티턴 시나리오입니다. 각 시나리오는 **5턴 이상**으로 구성됩니다.

### B.1 🎓 신입생 시나리오

#### 시나리오 1: 휴학 문의 → 장학금 연계 → 복학
```
[Turn 1] "휴학하고 싶어요"
기대: 휴학 종류, 기본 절차 안내
중단점: 휴학 종류가 언급되지 않으면 실패

[Turn 2] "일반휴학이요. 신청 기간이 언제예요?"
기대: 구체적 신청 기간 + 필요 서류
맥락 검증: "일반휴학"이 맥락에 유지되는지 확인

[Turn 3] "장학금 받고 있는데 어떻게 돼요?"
기대: 장학금 유형별 처리 방법
맥락 검증: 휴학 맥락 유지 + 장학금 정보 추가

[Turn 4] "그럼 복학할 때는요?"
기대: 복학 절차 + 장학금 재신청 여부
맥락 검증: 휴학 → 장학금 → 복학 흐름 유지

[Turn 5] "휴학 기간은 얼마까지 가능해요?"
기대: 최대 휴학 기간 + 연장 가능 여부
```

#### 시나리오 2: 경제적 어려움 → 종합 지원
```
[Turn 1] "돈이 없어서 학교 다니기 힘들어요"
기대: 공감 + 지원 옵션 개요 (장학금, 분납, 근로)
중단점: 단순 위로만 하면 실패

[Turn 2] "장학금 종류가 뭐가 있어요?"
기대: 교내/교외 장학금 목록 + 신청 조건

[Turn 3] "성적이 안 좋은데도 받을 수 있어요?"
기대: 성적 기준 + 성적 무관 장학금 안내

[Turn 4] "등록금 분납은 어떻게 해요?"
기대: 분납 신청 절차 + 기한 + 조건

[Turn 5] "근로장학생은요?"
기대: 근로장학 신청 방법 + 근무 조건 + 급여
```

### B.2 👨‍🏫 신임 교수 시나리오

#### 시나리오 1: 연구년 문의
```
[Turn 1] "연구년 제도에 대해 알고 싶습니다"
기대: 연구년 개요 + 자격 조건 요약

[Turn 2] "신청 자격이 어떻게 되나요?"
기대: 구체적 자격 요건 (재직 기간, 업적 등)

[Turn 3] "해외 연구년도 가능한가요?"
기대: 해외 연구년 조건 + 지원 내용

[Turn 4] "연구년 중 급여는 어떻게 되나요?"
기대: 급여 지급 비율 + 조건

[Turn 5] "신청 절차와 기한을 알려주세요"
기대: 구체적 절차 + 신청 기한 + 필요 서류
```

### B.3 🤕 어려운 상황의 학생 시나리오

#### 시나리오 1: 학사경고 → 대처방안
```
[Turn 1] "학사경고 받았어요... 어떡하죠?"
기대: 공감 + 학사경고 의미 + 대처 옵션
중단점: 공감 없이 규정만 나열하면 부분성공

[Turn 2] "몇 번 받으면 제적이에요?"
기대: 구체적 제적 기준 (연속/누적)

[Turn 3] "이번 학기 성적 올리면 괜찮아요?"
기대: 학사경고 해제 조건 + 유예 제도 안내

[Turn 4] "성적이 너무 안 좋은 과목 철회할 수 있어요?"
기대: 수강 철회/포기 제도 + 조건 + 기한

[Turn 5] "학습 도움 받을 수 있는 곳 있어요?"
기대: 학습지원센터, 튜터링 등 지원 프로그램
```

### B.4 멀티턴 평가 기록 양식

```
[시나리오] 신입생 - 휴학 문의
[실행 일시] 2026-01-14 14:30

Turn 1: ✅ 성공 (맥락 설정 완료)
Turn 2: ✅ 성공 (맥락 유지 + 구체 정보)
Turn 3: ⚠️ 부분성공 (장학금 유형 일부 누락)
Turn 4: ❌ 실패 (맥락 단절 - 휴학 언급 없이 복학만 설명)
Turn 5: - (Turn 4 실패로 중단)

[멀티턴 점수]
- 맥락 유지: 3/5
- 정보 일관성: 4/5
- 점진적 심화: 3/5
- 중복 회피: 5/5
- 자연스러운 전환: 3/5
- 후속 질문 예측: 4/5
- 총점: 3.7/5.0

[판정] ⚠️ 부분성공 → 실패로 카운트
[근본 원인] Turn 4에서 맥락(휴학) 유실 → 컨텍스트 윈도우 문제 가능성
```
```

---

## Further Considerations

### 1. evaluation_dataset.json 확장 필요?

현재 50개 케이스에 멀티턴 테스트 케이스가 0개입니다.

**옵션 A**: 프롬프트만 먼저 업그레이드 (권장)
- 장점: 빠른 적용, 수동 테스트로 즉시 검증 가능
- 단점: 자동화된 멀티턴 테스트 불가

**옵션 B**: 프롬프트 + 데이터셋 동시 업그레이드
- 장점: 완전한 자동화 가능
- 단점: auto_evaluate.py 수정 필요, 작업량 증가

**결정 필요**: A 또는 B?

---

### 2. 자동화 수준 선택

팩트체크 자동화 수준:

**옵션 A**: 완전 수동 (현재)
- 모든 검증 쿼리를 테스터가 직접 실행

**옵션 B**: 반자동 (권장)
- 답변에서 조항 추출 → 검증 쿼리 자동 생성
- 테스터가 결과만 확인

**옵션 C**: 완전 자동
- LLM이 검증까지 수행
- 비용 증가, 신뢰성 검증 필요

**결정 필요**: A, B, 또는 C?

---

### 3. 멀티턴 테스트 실행 방식

**옵션 A**: CLI 인터랙티브 모드 수동 테스트 유지
- 현재 방식 그대로

**옵션 B**: 멀티턴 테스트 자동화 스크립트 신규 개발
- scripts/test_multiturn.py 신규 작성
- evaluation_dataset.json에 멀티턴 케이스 추가 필요

**결정 필요**: A 또는 B?

---

## 예상 작업량

| Step | 예상 시간 | 의존성 |
|------|----------|--------|
| Step 1 (의도 충족 검증) | 30분 | 없음 |
| Step 2 (멀티턴 필수화) | 20분 | 없음 |
| Step 3 (부분성공=실패 강화) | 20분 | 없음 |
| Step 4 (후속 질문 검증) | 15분 | 없음 |
| Step 5 (5-Why 분석) | 20분 | 없음 |
| Step 6 (시나리오 라이브러리) | 40분 | 없음 |
| **총계** | **~2.5시간** | |
