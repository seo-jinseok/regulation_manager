.........................................F.F............................ [  9%]
......F................................................................. [ 19%]
........................................................................ [ 29%]
........................................................................ [ 39%]
........................................................................ [ 49%]
.........FFFF.F......................................................... [ 59%]
........................................................................ [ 69%]
..............................................................F......... [ 79%]
........................................................................ [ 89%]
........................................................................ [ 99%]
....                                                                     [100%]
=================================== FAILURES ===================================
_________________ test_hybrid_filters_abolished_sparse_results _________________

    def test_hybrid_filters_abolished_sparse_results():
        """Hybrid Í≤ÄÏÉâÏóêÏÑú BM25 Í≤∞Í≥ºÎèÑ ÌèêÏßÄ Í∑úÏ†ï ÌïÑÌÑ∞ÎßÅÎê®."""
        documents = [
            (
                "doc_active",
                "Ìú¥Ìïô Ï†àÏ∞® ÏïàÎÇ¥",
                {
                    "rule_code": "1-1-1",
                    "level": "article",
                    "title": "Ìú¥Ìïô",
                    "parent_path": "ÌïôÏÉùÍ∑úÏ†ï",
                    "status": "active",
                },
            ),
            (
                "doc_abolished",
                "Ìú¥Ìïô Ï†àÏ∞® ÏïàÎÇ¥",
                {
                    "rule_code": "1-1-2",
                    "level": "article",
                    "title": "Ìú¥Ìïô",
                    "parent_path": "ÌïôÏÉùÍ∑úÏ†ï",
                    "status": "abolished",
                },
            ),
        ]
        store = FakeStoreWithDocs(results=[], documents=documents)
        usecase = SearchUseCase(store, use_reranker=False, use_hybrid=True)
    
        results = usecase.search("Ìú¥Ìïô", top_k=5, include_abolished=False)
    
>       assert {r.chunk.id for r in results} == {"doc_active"}
E       AssertionError: assert {'47128af8-27...921f768ca5d6'} == {'doc_active'}
E         
E         Extra items in the left set:
E         'c023a4b9-bd49-5392-8833-c7434f163a2c'
E         'c9009434-bfc7-5c00-96c0-921f768ca5d6'
E         '58ac3a18-7bfc-500d-be16-f03a9fdba6c5'
E         '7ae00d9b-f8f0-5079-b757-0a1d4603ebfc'
E         '47128af8-27f9-58f6-8225-3750967ef57f'...
E         
E         ...Full output truncated (3 lines hidden), use '-vv' to show

tests/rag/unit/application/test_search_usecase.py:225: AssertionError
__________________ test_hybrid_filters_by_rule_code_and_level __________________

    def test_hybrid_filters_by_rule_code_and_level():
        """Hybrid Í≤ÄÏÉâÏóêÏÑú BM25 Í≤∞Í≥ºÍ∞Ä rule_code/level ÌïÑÌÑ∞Î•º ÎßåÏ°±Ìï¥Ïïº Ìï®."""
        documents = [
            (
                "doc_allowed",
                "Ìú¥Ìïô Ï†àÏ∞® ÏïàÎÇ¥",
                {
                    "rule_code": "A-1-1",
                    "level": "article",
                    "title": "Ìú¥Ìïô",
                    "parent_path": "ÌïôÏÉùÍ∑úÏ†ï",
                    "status": "active",
                },
            ),
            (
                "doc_wrong_level",
                "Ìú¥Ìïô Ï†àÏ∞® ÏïàÎÇ¥",
                {
                    "rule_code": "A-1-1",
                    "level": "section",
                    "title": "Ìú¥Ìïô",
                    "parent_path": "ÌïôÏÉùÍ∑úÏ†ï",
                    "status": "active",
                },
            ),
            (
                "doc_wrong_rule",
                "Ìú¥Ìïô Ï†àÏ∞® ÏïàÎÇ¥",
                {
                    "rule_code": "B-1-1",
                    "level": "article",
                    "title": "Ìú¥Ìïô",
                    "parent_path": "ÌïôÏÉùÍ∑úÏ†ï",
                    "status": "active",
                },
            ),
        ]
        store = FakeStoreWithDocs(results=[], documents=documents)
        usecase = SearchUseCase(store, use_reranker=False, use_hybrid=True)
    
        filter = SearchFilter(rule_codes=["A-1-1"], levels=[ChunkLevel.ARTICLE])
        results = usecase.search("Ìú¥Ìïô", filter=filter, top_k=10, include_abolished=True)
    
>       assert {r.chunk.id for r in results} == {"doc_allowed"}
E       AssertionError: assert set() == {'doc_allowed'}
E         
E         Extra items in the right set:
E         'doc_allowed'
E         Use -v to get more diff

tests/rag/unit/application/test_search_usecase.py:289: AssertionError
___________ TestSearchUseCaseAsk.test_ask_includes_history_in_prompt ___________

self = <test_search_usecase_extended.TestSearchUseCaseAsk object at 0x132b1c450>

    def test_ask_includes_history_in_prompt(self):
        """History text is included in LLM prompt."""
        chunk = make_chunk()
        store = MockVectorStore([make_search_result(chunk)])
        llm = MockLLMClient()
    
        usecase = SearchUseCase(
            store,
            llm_client=llm,
            use_reranker=False,
            use_hybrid=False,
        )
        usecase._enable_self_rag = False  # Disable Self-RAG for this test
        usecase.ask(
            question="Îã§Ïùå ÏßàÎ¨∏",
            history_text="Ïù¥Ï†Ñ ÎåÄÌôî Í∏∞Î°ù",
        )
    
        _, user_message, _ = llm.generate_calls[0]
>       assert "ÎåÄÌôî Í∏∞Î°ù" in user_message
E       AssertionError: assert 'ÎåÄÌôî Í∏∞Î°ù' in 'ÏßàÎ¨∏: Îã§Ïùå ÏßàÎ¨∏'

tests/rag/unit/application/test_search_usecase_extended.py:498: AssertionError
__________________ TestQueryAnalyzer.test_get_weights_article __________________

self = <rag.unit.infrastructure.test_query_analyzer.TestQueryAnalyzer object at 0x132d5d510>
analyzer = <src.rag.infrastructure.query_analyzer.QueryAnalyzer object at 0x13a117fd0>

    def test_get_weights_article(self, analyzer: QueryAnalyzer):
        """ARTICLE_REFERENCEÎäî BM25 Í∞ÄÏ§ëÏπòÍ∞Ä ÎÜíÏïÑÏïº Ìï®"""
        bm25_w, dense_w = analyzer.get_weights("Ï†ú15Ï°∞")
>       assert bm25_w == 0.6
E       assert 0.9 == 0.6

tests/rag/unit/infrastructure/test_query_analyzer.py:124: AssertionError
________________ TestQueryAnalyzer.test_get_weights_regulation _________________

self = <rag.unit.infrastructure.test_query_analyzer.TestQueryAnalyzer object at 0x132d5dbd0>
analyzer = <src.rag.infrastructure.query_analyzer.QueryAnalyzer object at 0x13a0d76d0>

    def test_get_weights_regulation(self, analyzer: QueryAnalyzer):
        """REGULATION_NAMEÏùÄ Í∑†Ìòï Ïû°Ìûå Í∞ÄÏ§ëÏπò (ÎèôÏùòÏñ¥ ÏóÜÏùÑ Îïå)"""
        # "Ïù∏ÏÇ¨Í∑úÏ†ï"ÏùÄ ÎèôÏùòÏñ¥Í∞Ä ÏóÜÏñ¥ÏÑú Í∏∞Î≥∏ Í∞ÄÏ§ëÏπò Ï†ÅÏö©
        bm25_w, dense_w = analyzer.get_weights("Ïù∏ÏÇ¨Í∑úÏ†ï")
>       assert bm25_w == 0.5
E       assert 0.85 == 0.5

tests/rag/unit/infrastructure/test_query_analyzer.py:131: AssertionError
_________________ TestQueryAnalyzer.test_get_weights_question __________________

self = <rag.unit.infrastructure.test_query_analyzer.TestQueryAnalyzer object at 0x132d5e290>
analyzer = <src.rag.infrastructure.query_analyzer.QueryAnalyzer object at 0x132cc28d0>

    def test_get_weights_question(self, analyzer: QueryAnalyzer):
        """NATURAL_QUESTIONÏùÄ ÏïΩÍ∞Ñ Dense Í∞ÄÏ§ëÏπòÍ∞Ä ÎÜíÏùå (0.4, 0.6)"""
        bm25_w, dense_w = analyzer.get_weights("Ïù¥Í±¥ Î≠îÍ∞ÄÏöî?")
>       assert bm25_w == 0.4
E       assert 0.75 == 0.4

tests/rag/unit/infrastructure/test_query_analyzer.py:137: AssertionError
__________________ TestQueryAnalyzer.test_get_weights_intent ___________________

self = <rag.unit.infrastructure.test_query_analyzer.TestQueryAnalyzer object at 0x132d591d0>
analyzer = <src.rag.infrastructure.query_analyzer.QueryAnalyzer object at 0x13a114610>

    def test_get_weights_intent(self, analyzer: QueryAnalyzer):
        """INTENTÎäî Í∑†Ìòï Ïû°Ìûå Í∞ÄÏ§ëÏπò (0.6, 0.4)Î•º Í∞ÄÏßê (ÌÇ§ÏõåÎìú Ï£ºÏûÖÎê®)"""
        bm25_w, dense_w = analyzer.get_weights("ÌïôÍµêÏóê Í∞ÄÍ∏∞ Ïã´Ïñ¥")
>       assert bm25_w == 0.6
E       assert 0.85 == 0.6

tests/rag/unit/infrastructure/test_query_analyzer.py:143: AssertionError
__________________ TestQueryAnalyzer.test_get_weights_general __________________

self = <rag.unit.infrastructure.test_query_analyzer.TestQueryAnalyzer object at 0x132d5e4d0>
analyzer = <src.rag.infrastructure.query_analyzer.QueryAnalyzer object at 0x13a88b090>

    def test_get_weights_general(self, analyzer: QueryAnalyzer):
        """GENERALÏùÄ Í∑†Ìòï Í∞ÄÏ§ëÏπò (0.5, 0.5)"""
        bm25_w, dense_w = analyzer.get_weights("ÏùºÎ∞ò Í≤ÄÏÉâÏñ¥")
>       assert bm25_w == 0.5
E       assert 0.8 == 0.5

tests/rag/unit/infrastructure/test_query_analyzer.py:156: AssertionError
__ TestQueryHandlerAskExplanation.test_ask_includes_matching_info_in_sources ___

self = <test_query_handler_explanation.TestQueryHandlerAskExplanation object at 0x132f381d0>

    def test_ask_includes_matching_info_in_sources(self):
        """Ask result sources should include Îß§Ïπ≠ Ï†ïÎ≥¥."""
        # Setup mock chunks with keywords
        chunk = MockChunk(
            id="chunk1",
            text="Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ÏùÄ Îß§ÎÖÑ 3ÏõîÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.",
            title="Ï†ú15Ï°∞ Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠",
            rule_code="3-1-5",
            parent_path=["ÍµêÏõêÏù∏ÏÇ¨Í∑úÏ†ï", "Ïó∞Íµ¨ÎÖÑÏ†ú"],
            keywords=[MockKeyword(term="Ïó∞Íµ¨ÎÖÑ"), MockKeyword(term="Ïã†Ï≤≠")],
            level=ChunkLevel.ARTICLE,
            display_no="Ï†ú15Ï°∞",
        )
        mock_result = MockSearchResult(chunk=chunk, score=0.9, rank=1)
        mock_answer = MockAnswer(
            text="Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ÏùÄ Îß§ÎÖÑ 3ÏõîÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.",
            sources=[mock_result],
            confidence=0.85,
        )
    
        store = FakeVectorStore(count_value=100)
        llm_client = MagicMock()
        handler = QueryHandler(store=store, llm_client=llm_client)
    
        with patch.object(handler, 'store', store):
            with patch('src.rag.interface.query_handler.SearchUseCase') as MockSU:
                mock_su_instance = MagicMock()
                mock_su_instance.ask.return_value = mock_answer
                mock_su_instance.get_last_query_rewrite.return_value = None
                MockSU.return_value = mock_su_instance
    
                result = handler.ask("Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ ÏãúÍ∏∞Îäî?", options=QueryOptions())
    
        assert result.success is True
        assert result.type == QueryType.ASK
        # Sources section should include Îß§Ïπ≠ Ï†ïÎ≥¥
>       assert "Îß§Ïπ≠ Ï†ïÎ≥¥" in result.content
E       AssertionError: assert 'Îß§Ïπ≠ Ï†ïÎ≥¥' in 'Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ÏùÄ Îß§ÎÖÑ 3ÏõîÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.\n\n---\n\n### üìú Í¥ÄÎ†® Í∑úÏ†ï: ÍµêÏõêÏù∏ÏÇ¨Í∑úÏ†ï (Í∑úÏ†ïÏΩîÎìú: 3-1-5)\n**[Ï†ú15Ï°∞ Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠]**\nÏó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ÏùÄ Îß§ÎÖÑ 3ÏõîÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.\n*Í¥ÄÎ†®ÎèÑ: 100%*\n\n---\n'
E        +  where 'Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ÏùÄ Îß§ÎÖÑ 3ÏõîÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.\n\n---\n\n### üìú Í¥ÄÎ†® Í∑úÏ†ï: ÍµêÏõêÏù∏ÏÇ¨Í∑úÏ†ï (Í∑úÏ†ïÏΩîÎìú: 3-1-5)\n**[Ï†ú15Ï°∞ Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠]**\nÏó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ÏùÄ Îß§ÎÖÑ 3ÏõîÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.\n*Í¥ÄÎ†®ÎèÑ: 100%*\n\n---\n' = QueryResult(type=<QueryType.ASK: 'ask'>, success=True, content='Ïó∞Íµ¨ÎÖÑ Ïã†Ï≤≠ÏùÄ Îß§ÎÖÑ 3ÏõîÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.\n\n---\n\n### üìú Í¥ÄÎ†® Í∑úÏ†ï: ÍµêÏõêÏù∏ÏÇ¨Í∑úÏ†ï (Í∑ú...'ÍµêÏõêÏù∏ÏÇ¨Í∑úÏ†ï', 'last_rule_code': '3-1-5'}, clarification_type=None, clarification_options=[], debug_info='', suggestions=[]).content

tests/rag/unit/interface/test_query_handler_explanation.py:221: AssertionError
=============================== warnings summary ===============================
src/rag/automation/domain/entities.py:73
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:73: PytestCollectionWarning: cannot collect test class 'TestCase' because it has a __init__ constructor (from: tests/rag/unit/automation/domain/test_entities.py)
    @dataclass

src/rag/automation/domain/entities.py:92
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:92: PytestCollectionWarning: cannot collect test class 'TestSession' because it has a __init__ constructor (from: tests/rag/unit/automation/domain/test_entities.py)
    @dataclass

src/rag/automation/domain/entities.py:73
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:73: PytestCollectionWarning: cannot collect test class 'TestCase' because it has a __init__ constructor (from: tests/rag/unit/automation/infrastructure/test_json_session_repository.py)
    @dataclass

src/rag/automation/domain/entities.py:92
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:92: PytestCollectionWarning: cannot collect test class 'TestSession' because it has a __init__ constructor (from: tests/rag/unit/automation/infrastructure/test_json_session_repository.py)
    @dataclass

src/rag/automation/domain/entities.py:120
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:120: PytestCollectionWarning: cannot collect test class 'TestResult' because it has a __init__ constructor (from: tests/rag/unit/automation/test_phase2/test_auto_fact_checker.py)
    @dataclass

src/rag/automation/domain/entities.py:73
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:73: PytestCollectionWarning: cannot collect test class 'TestCase' because it has a __init__ constructor (from: tests/rag/unit/automation/test_phase2/test_execute_test_usecase.py)
    @dataclass

src/rag/automation/domain/entities.py:120
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:120: PytestCollectionWarning: cannot collect test class 'TestResult' because it has a __init__ constructor (from: tests/rag/unit/automation/test_phase2/test_quality_evaluator.py)
    @dataclass

src/rag/automation/domain/entities.py:120
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:120: PytestCollectionWarning: cannot collect test class 'TestResult' because it has a __init__ constructor (from: tests/rag/unit/automation/test_phase4/test_component_analyzer.py)
    @dataclass

src/rag/automation/domain/entities.py:120
  /Users/truestone/Dropbox/repo/University/regulation_manager/src/rag/automation/domain/entities.py:120: PytestCollectionWarning: cannot collect test class 'TestResult' because it has a __init__ constructor (from: tests/rag/unit/automation/test_phase5/test_failure_analyzer.py)
    @dataclass

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.11.14-final-0 _______________

Name                                                           Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------------
src/__init__.py                                                    0      0   100%
src/analyze_json.py                                              101     42    58%   10, 20-21, 23, 26, 31, 41, 43, 48, 55, 61, 64-69, 77-78, 83-85, 89, 107-111, 116, 121-141, 145
src/cache_manager.py                                             121     31    74%   31-34, 41-42, 62, 89, 94-98, 106-112, 119-126, 165, 168-169
src/converter.py                                                 111     40    64%   15-16, 63, 98-104, 126, 141, 145, 154-155, 166, 170-176, 201-214, 224-239, 253-254, 259-265
src/enhance_for_rag.py                                           265     67    75%   87, 318, 366, 372, 493, 502, 551-597, 601-656, 660
src/exceptions.py                                                 46     16    65%   30-33, 46-48, 66-67, 97-99, 112-113, 131-132
src/formatter.py                                                 518    177    66%   29, 35-37, 62-78, 95-100, 118, 127-128, 138-143, 175, 182, 196-198, 210, 219, 227-234, 246-247, 257, 272, 357, 388-389, 427-436, 548, 552-554, 559, 561, 563, 602, 621, 638, 763, 768-829, 837-902, 909-941, 949, 961-1065, 1075, 1091, 1098, 1125-1126
src/inspect_json.py                                               57     17    70%   12-13, 19, 50, 58, 62-69, 73-81, 85
src/interactive.py                                               149     33    78%   30-31, 43-46, 66-81, 89-92, 142-145, 185, 210-211, 218, 266-274, 283, 301-302
src/llm_client.py                                                 65     16    75%   12-15, 19-20, 41, 63, 108-118, 134-136, 139-140
src/main.py                                                      358    108    70%   64, 72, 75-78, 140-141, 144-145, 164, 167-170, 177-178, 214-216, 219-228, 244-269, 280-313, 332-344, 348, 430, 467, 475, 512, 517-529, 593, 662-669, 684, 719-721, 730-731, 735
src/metadata_extractor.py                                         89      0   100%
src/parsing/__init__.py                                            5      0   100%
src/parsing/html_table_converter.py                               98     11    89%   18, 27, 36, 45, 51, 58, 74, 118, 122, 128-129
src/parsing/id_assigner.py                                        74      9    88%   47, 91, 101-102, 121-124, 128
src/parsing/reference_resolver.py                                134     90    33%   54-67, 93-107, 133-137, 140-152, 173-225, 235-261, 265-267
src/parsing/regulation_parser.py                                 199     75    62%   158-197, 206, 241-251, 297-300, 303-311, 314, 332-367, 398-401
src/parsing/table_extractor.py                                    53      6    89%   42-46, 86, 103, 107
src/preprocessor.py                                              108     16    85%   27, 30, 54, 71-75, 87, 94, 99-101, 122, 175-176, 183-184
src/rag/__init__.py                                                0      0   100%
src/rag/application/__init__.py                                    4      0   100%
src/rag/application/auto_learn.py                                159    159     0%   8-489
src/rag/application/evaluate.py                                  117     57    51%   96, 133-205, 217-221, 225-226, 230-232, 249-268, 281-294, 298-315
src/rag/application/full_view_usecase.py                         359    115    68%   80, 83-84, 86, 103, 124, 127-128, 130, 149-190, 194-222, 233, 236-237, 239, 280, 285, 287, 297, 312-313, 321-329, 340, 347, 353, 357, 363, 385, 397, 404-407, 458-465, 487-488, 493, 497-498, 500-501, 507-532
src/rag/application/search_usecase.py                            775    181    77%   82, 87, 111-116, 121, 241, 243-244, 256, 311-312, 399, 459, 484-540, 562-567, 601-702, 772, 774, 776, 778, 783, 788, 792, 838, 923-924, 953, 988, 994, 1004, 1030, 1166-1176, 1197, 1229, 1257, 1298, 1302, 1319, 1336-1338, 1364, 1368, 1384-1386, 1418, 1425-1431, 1488-1490, 1534, 1538, 1556, 1569, 1630, 1683-1684, 1712, 1721-1724, 1782, 1786, 1793, 1801, 1808-1840, 1871-1937, 1990, 1993, 2004-2007, 2019, 2023, 2026, 2050-2051, 2086-2089, 2098
src/rag/application/sync_usecase.py                               76      5    93%   164-166, 196-197
src/rag/application/synonym_generator_service.py                  91      1    99%   235
src/rag/automation/__init__.py                                     0      0   100%
src/rag/automation/application/__init__.py                         0      0   100%
src/rag/automation/application/apply_improvement_usecase.py      153    153     0%   10-463
src/rag/automation/application/execute_test_usecase.py            54      4    93%   148-154
src/rag/automation/application/generate_test_usecase.py           36      0   100%
src/rag/automation/domain/__init__.py                              0      0   100%
src/rag/automation/domain/context_tracker.py                      98     23    77%   159, 207-208, 228, 242-265, 287, 304, 322, 349-350
src/rag/automation/domain/entities.py                            134     17    87%   110, 115-117, 198, 203-206, 211-217, 245-247
src/rag/automation/domain/repository.py                           16      4    75%   32, 45, 55, 68
src/rag/automation/domain/value_objects.py                        88      3    97%   104, 136, 164
src/rag/automation/infrastructure/__init__.py                      0      0   100%
src/rag/automation/infrastructure/auto_fact_checker.py           105     10    90%   171, 183-185, 237, 267, 285-287, 307
src/rag/automation/infrastructure/component_analyzer.py          158     49    69%   181-189, 193-198, 202-208, 213-214, 219-220, 224-229, 237-238, 245-251, 265-266, 275-276, 307-308, 346, 348, 354, 368, 373, 397-398, 425-427, 432
src/rag/automation/infrastructure/failure_analyzer.py            145     36    75%   139-140, 147-151, 202, 204, 206, 209-213, 218, 220, 222, 224, 231, 233, 235, 237, 244, 246, 248, 270, 273, 276, 282, 298, 302, 323, 351-363
src/rag/automation/infrastructure/json_session_repository.py      50      0   100%
src/rag/automation/infrastructure/llm_persona_generator.py        21      0   100%
src/rag/automation/infrastructure/llm_query_generator.py          74      3    96%   247, 330, 345
src/rag/automation/infrastructure/multi_turn_simulator.py        106    106     0%   10-466
src/rag/automation/infrastructure/quality_evaluator.py            74      1    99%   221
src/rag/automation/infrastructure/test_report_generator.py       163    163     0%   10-492
src/rag/config.py                                                 81     14    83%   123, 128, 133, 138, 143-145, 150-152, 157, 167, 173, 179
src/rag/domain/__init__.py                                         4      0   100%
src/rag/domain/entities.py                                       114      5    96%   166-169, 173-174
src/rag/domain/repositories.py                                    75     22    71%   34, 47, 67, 77, 87, 97, 107, 128, 144, 159, 172, 186, 200, 216, 244, 257, 285, 304, 318, 340, 350, 363
src/rag/domain/value_objects.py                                   57      0   100%
src/rag/exceptions.py                                             12      4    67%   35-36, 49-50
src/rag/infrastructure/__init__.py                                 2      0   100%
src/rag/infrastructure/chroma_store.py                           120     54    55%   16-17, 50, 86-113, 125-137, 161-164, 169, 183-197, 205, 237-238, 258-269, 295
src/rag/infrastructure/fact_checker.py                            90      3    97%   58, 142, 227
src/rag/infrastructure/feedback.py                                91     91     0%   8-225
src/rag/infrastructure/function_gemma_adapter.py                 396    343    13%   33-36, 43-45, 134-152, 158-170, 174, 178, 182, 186-217, 221-257, 261-272, 279-306, 321-416, 438-461, 467-525, 535-711, 718-735, 745-792, 811-865, 881-936, 940-947, 951-956, 964-1008
src/rag/infrastructure/hybrid_search.py                          244     34    86%   37-42, 145, 160, 178, 182, 185-187, 231, 267, 273, 279-285, 346-347, 389-390, 404-405, 411-412, 474, 481, 575
src/rag/infrastructure/hyde.py                                   106     27    75%   100-101, 106-113, 121, 146-179, 224, 306-307
src/rag/infrastructure/json_loader.py                            202     76    62%   31, 51, 55, 116, 158-160, 228-241, 285, 294, 299, 317-354, 365-385, 389-408, 412-424
src/rag/infrastructure/keyword_extractor.py                      117    117     0%   8-330
src/rag/infrastructure/llm_adapter.py                             19     11    42%   45-52, 78-88, 107-118, 126
src/rag/infrastructure/llm_cache.py                               76     76     0%   8-199
src/rag/infrastructure/llm_client.py                              36     23    36%   14-15, 43-54, 73-83, 95-100, 115, 120-128
src/rag/infrastructure/patterns.py                                22      3    86%   99, 111, 123
src/rag/infrastructure/query_analyzer.py                         481     75    84%   462, 464, 466, 471, 473, 500-501, 505-508, 530, 603, 605, 608-613, 622, 682, 734, 754, 756, 759, 863, 921-948, 1011, 1028, 1037-1040, 1088, 1092-1093, 1099, 1103, 1106, 1108, 1112, 1118, 1148, 1152, 1156-1157, 1161, 1165, 1169, 1185, 1188-1189, 1192, 1217, 1237, 1369-1370, 1397, 1410, 1412, 1414, 1423
src/rag/infrastructure/query_expander.py                         140     12    91%   171-172, 183-184, 193, 285-286, 301-304, 366
src/rag/infrastructure/reranker.py                                88     21    76%   45, 55-65, 102, 139-169, 252
src/rag/infrastructure/retrieval_evaluator.py                     77      7    91%   112, 122, 127, 145, 218-221
src/rag/infrastructure/self_rag.py                               123     39    68%   87, 108, 120, 122-123, 153, 168-169, 184, 199, 201, 204-205, 252-253, 267-268, 272-274, 294, 297, 306-308, 322-334, 346, 361
src/rag/infrastructure/tool_definitions.py                        17     12    29%   303, 308-311, 316-324
src/rag/infrastructure/tool_executor.py                          142    111    22%   31, 41-45, 73-77, 90-104, 114-135, 141-169, 190-224, 235-238, 242-245, 249-253, 262-265, 274-280, 284-291, 302-310, 319-326, 337-346, 356-359, 363-367, 373-403, 411-414
src/rag/interface/__init__.py                                      0      0   100%
src/rag/interface/chat_logic.py                                  155     34    78%   8, 20, 40, 44, 56, 62, 66, 92, 96, 137, 155, 169, 179-184, 194, 199-202, 208-215, 238, 260, 275
src/rag/interface/cli.py                                         749    686     8%   25-26, 33-34, 65-67, 72-75, 80-83, 88-91, 98-159, 164-224, 229-516, 521-572, 577-586, 590-592, 596-605, 610-627, 634-759, 764-831, 836-844, 853, 872-877, 881-909, 919-1116, 1123-1127, 1132-1151, 1156-1158, 1164-1166, 1171-1245, 1250-1282, 1287-1315, 1320-1349, 1354-1483, 1488-1504, 1508
src/rag/interface/common.py                                       26     16    38%   28-76
src/rag/interface/formatters.py                                  329     47    86%   181-185, 190-193, 231, 237, 248, 255, 259, 306, 333, 337, 340, 348, 351, 366, 369, 381, 383, 400, 402, 437, 488, 503-508, 521, 547, 564-565, 575-583, 588, 591, 594, 597, 600
src/rag/interface/gradio_app.py                                  492    267    46%   23-24, 30-31, 48-50, 75, 87, 98, 113, 160-162, 193-196, 241, 265, 286-287, 291-293, 306-312, 319-332, 335-337, 340-381, 396-446, 468-565, 588-748, 752-765, 771-772, 782-783, 807, 948-952, 959-967, 992-1037, 1053-1073, 1089-1108, 1127-1150, 1289, 1314, 1328-1337, 1357
src/rag/interface/link_formatter.py                               89      9    90%   64, 82, 104-105, 138, 145, 171, 179, 222
src/rag/interface/mcp_server.py                                  146    146     0%   19-534
src/rag/interface/query_handler.py                               575    391    32%   64-67, 157-169, 218-225, 229-231, 266-291, 308-358, 377-465, 477-613, 617-634, 638-665, 674-744, 748, 755-851, 886-920, 943-989, 1014-1069, 1099-1151, 1177, 1184, 1205, 1257, 1313, 1320, 1327, 1342-1349, 1354-1359, 1370-1371, 1453
src/rag/interface/query_suggestions.py                            44      2    95%   112, 115
src/rag/interface/unified_cli.py                                 286    286     0%   20-947
src/rag/logging_config.py                                         35     35     0%   7-89
src/refine_json.py                                               125     46    63%   19, 29, 40, 45, 55, 76-77, 90, 118, 126-129, 143-146, 151, 156, 160, 170-205, 231-239, 245
src/repair.py                                                     63     57    10%   10-25, 32-91, 94-107
src/verify_json.py                                                58      8    86%   12-13, 67, 77-80, 83
--------------------------------------------------------------------------------------------
TOTAL                                                          11711   5054    57%
=========================== short test summary info ============================
FAILED tests/rag/unit/application/test_search_usecase.py::test_hybrid_filters_abolished_sparse_results
FAILED tests/rag/unit/application/test_search_usecase.py::test_hybrid_filters_by_rule_code_and_level
FAILED tests/rag/unit/application/test_search_usecase_extended.py::TestSearchUseCaseAsk::test_ask_includes_history_in_prompt
FAILED tests/rag/unit/infrastructure/test_query_analyzer.py::TestQueryAnalyzer::test_get_weights_article
FAILED tests/rag/unit/infrastructure/test_query_analyzer.py::TestQueryAnalyzer::test_get_weights_regulation
FAILED tests/rag/unit/infrastructure/test_query_analyzer.py::TestQueryAnalyzer::test_get_weights_question
FAILED tests/rag/unit/infrastructure/test_query_analyzer.py::TestQueryAnalyzer::test_get_weights_intent
FAILED tests/rag/unit/infrastructure/test_query_analyzer.py::TestQueryAnalyzer::test_get_weights_general
FAILED tests/rag/unit/interface/test_query_handler_explanation.py::TestQueryHandlerAskExplanation::test_ask_includes_matching_info_in_sources
9 failed, 715 passed, 10 deselected, 9 warnings in 14.60s
