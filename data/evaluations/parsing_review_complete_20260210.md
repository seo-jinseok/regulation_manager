# 규정집 파싱 문제 해결 보고서

**검토 일자**: 2026-02-10
**검토 대상**: 규정집 HWPX 파싱 결과 (JSON + Vector DB)

---

## 1. 해결 완료: ChromaDB doc_type 누락

### 문제
- 모든 청크의 `doc_type`이 `unknown`으로 설정됨
- 검색 필터링 기능 작동하지 않음

### 해결
- `Chunk` 데이터클래스에 `doc_type` 필드 추가
- 관련 메서드 수정 완료

### Vector DB 재구성 결과
```
=== 재구성 후 ChromaDB 상태 ===
총 청크 수: 17,254개
doc_type 분포:
  - regulation: 17,254개 (100%)
```

---

## 2. 규정 누락 문제 분석

### 현상
- TOC 514개 항목 vs 파싱된 규정 318개
- **196개 규정 누락** (38%)

### 파트별 누락 현황
| 파트 | TOC | 파싱 | 누락 | 파싱률 |
|------|-----|------|------|--------|
| 파트 1 | 1 | 1 | 0 | 100% |
| 파트 2 | 2 | 2 | 0 | 100% |
| 파트 3 | 248 | 176 | 72 | 71% |
| 파트 4 | 76 | 38 | 38 | 50% |
| 파트 5 | 147 | 82 | 65 | 56% |
| 파트 6 | 40 | 19 | 21 | 48% |

### 원인 분석

#### 1) HWPX 원본 확인
- HWPX 원본 파일에는 누락된 규정들이 **존재**함
- 예: "겸임교원규정", "시간강사위촉규정", "물품관리규정" 등이 원본에 있음

#### 2) 변환 과정 문제
- HWP → HTML → Markdown 변환 시 **페이지 헤더가 본문에 섞여 들어감**
- Raw Markdown 파일 예:
  ```
  제3편 행정 3—1—120～연구윤리센터규정 3—1—120～연구윤리센터규정
  ```
- 페이지 헤더 정보(`3—1—120～`)가 제목과 섞여 있어 파서가 제목을 올바르게 인식하지 못함

#### 3) 파서 로직 문제
- "Article 1 Split" 로직이 너무 공격적으로 규정을 분리함
- 깨진 제목 형식을 처리하지 못함

### 누락된 규정 예시
```
1. 겸임교원규정 (3-1-10)
2. 시간강사위촉규정【폐지】 (3-1-14)
3. 명예(조기)퇴직수당지급규정 (3-1-19)
4. 교원국내출장에관한규정【폐지】 (3-1-21)
5. 직원평정규정 (3-1-28)
6. 시설물사용에관한규정 (3-1-32)
7. 물품관리규정 (3-1-39)
8. 소방안전관리규정 (3-1-41)
...
총 196개
```

---

## 3. 권장 사항

### 1) 변환 프로세스 개선 (필수)
- HWP → HTML 변환 시 페이지 헤더 제거 로직 추가
- markdownify 변환 전후처리 개선

### 2) 파서 Robustness 개선 (권장)
- 깨진 제목 형식 처리 로직 추가
- 페이지 헤더 패턴 필터링

### 3) 대안: 별도 HWPX 파서 개발 (장기)
- HWPX XML 구조를 직접 파싱
- HTML 변환 과정 우회

---

## 4. 수정된 파일

### src/rag/domain/entities.py
- `Chunk` 데이터클래스에 `doc_type` 필드 추가
- `from_json_node()`, `to_metadata()`, `from_metadata()` 메서드 수정

### src/rag/infrastructure/json_loader.py
- `load_all_chunks()`, `load_chunks_by_rule_codes()`, `_extract_chunks_recursive()` 수정

### src/rag/infrastructure/self_rag.py
- 청크 생성 시 `doc_type` 파라미터 추가

### src/rag/application/search_usecase.py
- 캐시된 청크 재구성 시 `doc_type` 파라미터 추가

---

## 5. 현재 상태

### 완료된 항목
- ✅ ChromaDB doc_type 누락 해결
- ✅ Vector DB 재구성 완료 (17,254 청크)

### 남은 문제
- ⚠️ 196개 규정 누락 (변환 프로세스 개선 필요)

### 다음 단계
1. 변환 프로세스 개선으로 누락된 규정 복구
2. 파서 Robustness 개선
3. 전체 규정 파싱률 100% 달성 목표
