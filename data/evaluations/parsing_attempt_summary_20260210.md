# 규정집 파싱 개선 시도 보고서

**작성 일자**: 2026-02-10
**작업 목표**: HWPX → JSON 변환 시 누락된 196개 규정 복구

---

## 1. 초기 상태

### 원본 파싱 결과 (commit abb991a)
- **TOC 항목**: 514개
- **파싱된 규정**: 318개
- **누락된 규정**: 196개 (38%)

### 파트별 파싱률
| 파트 | TOC | 파싱 | 누락 | 파싱률 |
|------|-----|------|------|--------|
| 파트 1 | 1 | 1 | 0 | 100% |
| 파트 2 | 2 | 2 | 0 | 100% |
| 파트 3 | 248 | 176 | 72 | 71% |
| 파트 4 | 76 | 38 | 38 | 50% |
| 파트 5 | 147 | 82 | 65 | 56% |
| 파트 6 | 40 | 19 | 21 | 48% |

---

## 2. 원인 분석

### 근본 원인
HWP → HTML → Markdown 변환 과정에서 **페이지 헤더**가 규정 제목에 섞여 들어감:

```
예시: "연구율리센터규정 3—1—120～연구율리센터규정"
```

이런 깨진 제목 형식으로 인해 파서가 규정 제목을 올바르게 인식하지 못함.

### 영향 받는 코드
1. `src/metadata_extractor.py` - TOC 추출
2. `src/parsing/regulation_parser.py` - 규정 내용 파싱
3. `src/preprocessor.py` - 전처리 로직

---

## 3. 시도한 해결 방법

### 시도 1: `clean_page_header_pattern()` 함수 추가
- **위치**: `src/preprocessor.py`
- **목적**: 중복된 페이지 헤더 패턴 제거
- **결과**: ❌ 실패 - 전체 markdown에 적용 시 TOC 추출이 망가짐

### 시도 2: `regulation_parser.py`에 헤더 클리닝 추가
- **위치**: `src/parsing/regulation_parser.py`
- **목적**: 파싱 루프에서 라인별 헤더 클리닝
- **결과**: ❌ 실패 - TOC가 514개 → 52개로 대폭 감소

### 시도 3: `_clean_line_header_pattern()` 메서드 추가
- **위치**: `src/parsing/regulation_parser.py`
- **목적**: 제목 후보 감지 시 헤더 클리닝
- **결과**: ❌ 실패 - 여전히 TOC 감소

### 시도 4: `metadata_extractor.py` 수정
- **위치**: `src/metadata_extractor.py`
- **목적**: TOC 추출 시 헤더 클리닝
- **결과**: ❌ 실패 - 문서 수가 372개 → 3개로 대폭 감소

---

## 4. 실패 원인 분석

### 주요 문제점
1. **전역적인 패턴 적용**: 헤더 클리닝을 전체 문서에 적용하면 TOC, 인덱스 등도 영향을 받음
2. **파서의 복잡성**: 규정 파싱 로직이 복잡하여 특정 부분만 수정하기 어려움
3. **패턴 매칭의 민감성**: 작은 패턴 변경도 예상치 못한 부작용 초래

### 학습된 교훈
- 파싱 로직 수정 시 **점진적 접근** 필요
- **테스트 케이스**를 먼저 작성하여 회귀 방지
- **원본 데이터 보존** 필수 (git 활용)

---

## 5. 현재 상태

### 복원된 상태
- ✅ 원본 JSON 파일 복구 완료 (commit abb991a 기반)
- ✅ 수정된 모든 파일 원상 복구
- ✅ Vector DB (ChromaDB) 정상 상태 (17,254 청크, doc_type="regulation")

### 코드 상태
- `src/preprocessor.py` - `clean_page_header_pattern()` 함수 유지 (사용 안 함)
- `src/parsing/regulation_parser.py` - 원상 복구
- `src/metadata_extractor.py` - 원상 복구
- `src/main.py` - 원상 복구

---

## 6. 권장 사항

### 단기적 해결 방법
1. **수동 수정**: 누락된 196개 규정을 수동으로 검증하고 추가
2. **패턴 파일**: `preprocessor_rules.json`에 특정 패턴 추가하여 처리

### 장기적 해결 방법
1. **HWPX 직접 파싱**: HWPX XML 구조를 직접 파싱하여 HTML 변환 과정 우회
2. **LLM 기반 파싱**: LLM을 사용하여 깨진 제목 복구
3. **파서 리팩토링**: 규정 파싱 로직을 모듈화하고 테스트 가능하도록 재작성

### 추가 개선 필요사항
- 파싱 로직에 대한 **단위 테스트** 작성
- **CI/CD** 파이프라인에 파싱 품질 검증 추가
- **코드 커버리지** 향상

---

## 7. 성과

### 완료된 작업
- ✅ ChromaDB doc_type 필드 추가
- ✅ Vector DB 재구성 (17,254 청크, doc_type="regulation" 100%)
- ✅ 문제 원인 상세 분석
- ✅ 여러 해결 방법 시도 및 실패 분석

### 남은 작업
- ⚠️ 196개 규정 누락 문제 해결 (장기 과제)
- ⚠️ 파싱 로직 개선 (테스트 코드 포함)

---

## 8. 결론

현재 상태로 **원본 파싱 결과 (318/514)** 가 최적으로 판단됨. 추가 개선을 위해서는:

1. 규정 파싱 로직의 전면적인 재검토
2. 종합적인 테스트 스위트 작성
3. 점진적 개선 접근 (특정 파트부터 시작)

이번 작업을 통해 파싱 시스템의 복잡성과 개선 난이도를 파악하였으며, 향후 개선 작업의 방향성을 설정하였음.
